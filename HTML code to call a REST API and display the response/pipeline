pipeline {


    agent any


    environment {

        DOCKER_REGISTRY_CREDENTIALS = credentials('Docker')  // Load Docker credentials from Jenkins

    }


    // Define stages of the pipeline

    stages {

        stage('Build') {

            steps {

                dir('HTML code to call a REST API and display the response') {

                    sh 'ls'

                    sh 'docker build -t restapi_html -f Dockerfile .'

                }

            }

        }

 

        stage('Push to Docker Hub') {

            steps {

                // Log in to Docker Hub using credentials and push the Docker image

                withCredentials([usernamePassword(credentialsId: 'Docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {

                    sh """

                    docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

                    docker tag restapi_html pbhuvana16/pbhuvana16:restapi_html

                    docker push pbhuvana16/pbhuvana16:restapi_html

                    """

                }

            }

        }

 

        stage('Deploy to EC2') {

            steps {

                script {

                    ec2Host = '51.20.121.222'  // EC2 host

                    ec2User = 'ubuntu'         // SSH user on EC2

                    withCredentials([usernamePassword(credentialsId: 'Docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {

                    withCredentials([file(credentialsId: 'pemkey', variable: 'PRIVATE_KEY_FILE')]) {


                        sh """

                        chmod 400 $PRIVATE_KEY_FILE


                        # SSH into the EC2 instance and perform Docker-related tasks

                        ssh -i $PRIVATE_KEY_FILE -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $ec2User@$ec2Host << 'EOF'

                            sh "sudo docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD"

                            sudo docker pull pbhuvana16/pbhuvana16:restapi_html

                            sudo docker run -d -p 5001:5001 pbhuvana16/pbhuvana16:restapi_html


                        """

                    }

                  }

                }

            }

        }

    }

}
